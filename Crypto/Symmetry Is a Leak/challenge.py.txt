#!/usr/bin/env python3

from ecdsa import SigningKey, SECP256k1
from hashlib import sha256
import random
import math

# =========================
# ClawCTF â€“ Secret Setup
# =========================

FLAG = b"ClawCTF{th3_cl4ws_w3r3_n3v3r_r4nd0m_9f1a72cdd9e3a11}"

CURVE = SECP256k1
q = CURVE.order
t = 2048            # non-standard base
BLOCKS = 5
BLOCK_SIZE = 4      # decimal digits
SIGS = 64

# Embed flag inside private key
flag_int = int.from_bytes(FLAG, "big")

sk = SigningKey.generate(curve=CURVE)
d = sk.privkey.secret_multiplier
d = (d & ((1 << 240) - 1)) | (flag_int << 240)

sk = SigningKey.from_secret_exponent(d, curve=CURVE)
vk = sk.verifying_key

# =========================
# Nonce Construction
# =========================

def structured_nonce():
    blocks = [random.randint(1000, 9999) for _ in range(BLOCKS)]
    k = 0
    for b in blocks:
        k = k * 10**BLOCK_SIZE + b
    k = (k << 80) | random.getrandbits(80)
    return k, blocks

# =========================
# Leakage Function
# =========================

def leak(blocks):
    a,b,c,d,e = blocks

    n1 = a*t**4 + b*t**3 + c*t**2 + d*t + e
    n2 = e*t**4 + d*t**3 + c*t**2 + b*t + a

    return n1 * n2 + (a*b + c*d + e)**3

# =========================
# Sign Messages
# =========================

def sign_message(msg):
    k, blocks = structured_nonce()
    h = int.from_bytes(sha256(msg).digest(), "big")
    sig = sk.sign(msg, hashfunc=sha256, k=k)
    r = int.from_bytes(sig[:32], "big")
    s = int.from_bytes(sig[32:], "big")
    return h, r, s, leak(blocks)

# =========================
# Output Public Data
# =========================

print("curve = secp256k1")
print(f"q = {hex(q)}")
print(f"pubkey_x = {vk.pubkey.point.x()}")
print(f"pubkey_y = {vk.pubkey.point.y()}")
print()

for i in range(SIGS):
    h, r, s, l = sign_message(f"clawctf-msg-{i}".encode())
    print(f"hash_{i} = {h}")
    print(f"r_{i} = {r}")
    print(f"s_{i} = {s}")
    print(f"leak_{i} = {l}")
    print()
